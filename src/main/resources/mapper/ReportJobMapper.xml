<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.mapper.ReportJobMapper">

    <resultMap id="ReportJobMap" type="com.example.demo.model.ReportJob">
        <id property="id" column="id"/>
        <result property="username" column="username"/>
        <result property="fromDate" column="from_date"/>
        <result property="toDate" column="to_date"/>
        <result property="format" column="format"/>
        <result property="status" column="status"/>
        <result property="filePath" column="file_path"/>
        <result property="errorMessage" column="error_message"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <insert id="insert" parameterType="com.example.demo.model.ReportJob" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO
            report_jobs (username, from_date, to_date, format, status, file_path, error_message)
        VALUES
            (#{username}, #{fromDate}, #{toDate}, #{format}, #{status}, #{filePath}, #{errorMessage})
    </insert>

    <select id="selectById" resultMap="ReportJobMap" parameterType="long">
        SELECT
            *
        FROM
            report_jobs
        WHERE
            id = #{id}
    </select>

    <update id="updateStatus" parameterType="map">
        UPDATE report_jobs
        SET
            status          = #{status}
            , file_path     = #{filePath}
            , error_message = #{errorMessage}
            , updated_at    = NOW()
        WHERE
            id = #{id}
    </update>

    <select id="selectPending" resultMap="ReportJobMap">
        SELECT
            *
        FROM
            report_jobs
        WHERE
            status = 'PENDING'
        ORDER BY
            created_at FOR UPDATE SKIP LOCKED
    </select>

</mapper>

