<head th:replace="fragments/head :: commonHead('タイムシート')">
    <title>タイムシート</title>
</head>
<div th:fragment="content">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <!-- Existing content on the left side -->
            <div></div>

            <!-- Moved content to the right side -->
            <div class="d-flex gap-2 align-items-center">
                <button class="btn btn-sm btn-outline-secondary" id="prevMonth" title="前の月" type="button">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <input class="form-control form-control-sm" id="monthInput" style="width:160px;"
                       th:value="${yearMonthValue}" title="表示する月" type="month">
                <button class="btn btn-sm btn-outline-secondary" id="nextMonth" title="次の月" type="button">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- Report buttons: placed above the table, right-aligned -->
        <div class="d-flex justify-content-end align-items-center mb-2">
            <div class="d-flex gap-2">
                <!-- Removed CSV, PDF, and Excel download buttons -->
            </div>
        </div>
        <div aria-live="polite" class="text-muted small mb-2" id="reportMessage"></div>

        <!-- デフォルト設定アコーディオン -->
        <div class="accordion mb-3" id="defaultSettingsAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingDefaults">
                    <button aria-controls="collapseDefaults" aria-expanded="false" class="accordion-button collapsed"
                            data-bs-target="#collapseDefaults" data-bs-toggle="collapse" type="button">
                        デフォルト設定
                    </button>
                </h2>
                <div aria-labelledby="headingDefaults" class="accordion-collapse collapse"
                     data-bs-parent="#defaultSettingsAccordion"
                     id="collapseDefaults">
                    <div class="accordion-body">
                        <div class="d-flex gap-2 align-items-center">
                            <div class="form-floating" style="width:110px;">
                                <input class="form-control form-control-sm" id="defaultStart"
                                       title="出勤時刻のデフォルト値"
                                       type="time" value="09:00">
                                <label for="defaultStart">出勤</label>
                            </div>
                            <div class="form-floating" style="width:110px;">
                                <input class="form-control form-control-sm" id="defaultEnd"
                                       title="退勤時刻のデフォルト値"
                                       type="time" value="18:00">
                                <label for="defaultEnd">退勤</label>
                            </div>
                            <div class="form-floating" style="width:90px;">
                                <input class="form-control form-control-sm" id="defaultBreak" min="0" type="number"
                                       value="60">
                                <label for="defaultBreak">休憩(分)</label>
                            </div>
                            <button class="btn btn-sm btn-secondary" id="applyDefaults">空セルに適用</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 祝日アコーディオン -->
        <div class="accordion mb-3" id="holidayAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingHolidays">
                    <button aria-controls="collapseHolidays" aria-expanded="false" class="accordion-button collapsed"
                            data-bs-target="#collapseHolidays" data-bs-toggle="collapse" type="button">
                        当月の祝日
                    </button>
                </h2>
                <div aria-labelledby="headingHolidays" class="accordion-collapse collapse" id="collapseHolidays">
                    <div class="accordion-body" id="holidayInfo">
                        <!-- JavaScriptで祝日情報を挿入 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- テーブルヘッダ拡張 -->
        <div class="timesheet-table-container">
            <table class="table table-sm table-bordered table-hover" id="workTable">
                <thead class="table-light sticky-header">
                <tr>
                    <th class="col-date">日付</th>
                    <th class="col-weekday">曜日</th>
                    <th class="col-holiday">休日出勤</th>
                    <th class="col-note">備考</th>
                    <th class="col-start">出勤</th>
                    <th class="col-end">退勤</th>
                    <th class="col-break">休憩</th>
                    <th class="col-duration">稼働</th>
                    <th class="col-working">実働</th>
                    <th class="col-action">操作</th>
                </tr>
                </thead>
                <tbody id="tableBody">
                <tr th:classappend="${d == T(java.time.LocalDate).now()} ? 'table-primary' : ''"
                    th:each="d : ${dates}">
                    <td class="date-cell" th:data-iso="${#temporals.format(d,'yyyy-MM-dd')}">
                        <span th:text="${d.dayOfMonth + '日'}">1日</span>
                        <span class="holiday" style="display:none;"></span>
                    </td>
                    <td class="weekday-cell"></td>
                    <td class="holiday-cell d-none d-md-table-cell">
                        <div class="form-check form-switch">
                            <input aria-label="休日出勤" class="form-check-input holiday-switch" role="switch"
                                   type="checkbox">
                        </div>
                    </td>
                    <td class="note-cell">
                        <label class="visually-hidden"
                               for="note-select-[[${#temporals.format(d,'yyyy-MM-dd')}]]">備考</label>
                        <select class="form-select form-select-sm note-select"
                                id="note-select-[[${#temporals.format(d,'yyyy-MM-dd')}]]" title="備考">
                            <option value="">---</option>
                            <option value="午前休">午前休</option>
                            <option value="午後休">午後休</option>
                        </select>
                    </td>
                    <td class="time-cell" data-type="start"></td>
                    <td class="time-cell" data-type="end"></td>
                    <td class="break-cell d-none d-sm-table-cell" contenteditable="true"></td>
                    <td class="duration-cell d-none d-md-table-cell"></td>
                    <td class="working-cell d-none d-lg-table-cell"></td>
                    <td class="clear-cell">
                        <button class="btn btn-outline-secondary btn-sm clear-row-btn" type="button">
                            <span class="d-none d-sm-inline">クリア</span>
                            <i class="bi bi-x-lg d-sm-none"></i>
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Add three line breaks at the bottom of the table for the mobile version -->
        <div class="d-block d-md-none">
            <br>
            <br>
            <br>
        </div>
    </div>

    <!-- Time Picker -->
    <div aria-hidden="true" class="time-picker" id="timePicker" style="display:none;">
        <div class="picker-header">
            <div>
                <span class="selected-date" id="selectedDateLabel">日付: —</span>
                <span aria-hidden="true" class="selected-holiday" id="holidayLabel" style="display:none;"></span>
            </div>
            <div class="label-small" id="cellTypeLabel">種類: —</div>
        </div>

        <div class="display" id="timeDisplay">00:00</div>
        <div class="mode" id="modeLabel">時を設定してください (0-23)</div>

        <div class="clock" id="clock">
            <div class="hand" id="hand"></div>
            <div class="center-dot"></div>
            <div class="drag-area" id="dragArea"></div>
        </div>
    </div>

    <!-- Conflict Modal -->
    <div aria-hidden="true" class="modal fade" id="conflictModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">競合が発生しました</h5>
                    <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
                </div>
                <div class="modal-body">
                    <p>他の端末で同じ日付が更新されました。どうしますか？</p>
                    <p class="small text-muted">
                        再読み込みすると最新データを取得します。強制上書きを選ぶと現在の編集内容で上書きします。</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="conflictReload" type="button">再読み込み</button>
                    <button class="btn btn-danger" id="conflictForce" type="button">強制上書き</button>
                </div>
            </div>
        </div>
    </div>


    <script defer th:src="@{/js/timesheetMonth.js}"></script>
    <script th:inline="javascript">
        window.currentUserName = /*[[${currentUserName}]]*/ 'user1';
    </script>
</div>