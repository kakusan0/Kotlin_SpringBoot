<div th:fragment="content">
    <div class="container-fluid">
        <h2 class="mb-3" th:text="${monthDisplay}">2025年11月</h2>

        <!-- controls -->
        <div class="controls mb-3 d-flex gap-3 align-items-center flex-wrap">
            <div class="d-flex gap-2 align-items-center">
                <label class="form-label mb-0 small">出勤デフォルト：</label>
                <input class="form-control form-control-sm" id="defaultStart" style="width:110px;" type="time"
                       value="09:00">
                <label class="form-label mb-0 small">退勤デフォルト：</label>
                <input class="form-control form-control-sm" id="defaultEnd" style="width:110px;" type="time"
                       value="18:00">
                <button class="btn btn-sm btn-secondary" id="applyDefaults">空セルに適用</button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-sm table-bordered table-hover" id="workTable">
                <thead class="table-light">
                <tr>
                    <th style="width:280px;">日付</th>
                    <th style="width:100px;">出勤</th>
                    <th style="width:100px;">退勤</th>
                </tr>
                </thead>
                <tbody id="tableBody">
                <tr th:classappend="${d == T(java.time.LocalDate).now()} ? 'table-primary' : ''"
                    th:each="d : ${dates}">
                    <td class="date-cell text-start"
                        th:data-iso="${#temporals.format(d, 'yyyy-MM-dd')}"
                        th:title="${#temporals.format(d, 'yyyy-MM-dd')}">
                        <span th:classappend="${#temporals.dayOfWeek(d) == 7} ? 'weekday-sun' : (${#temporals.dayOfWeek(d) == 6} ? 'weekday-sat' : '')"
                              th:text="${#temporals.format(d, 'MM/dd (E)')}">11/23 (土)</span>
                        <span class="holiday" style="display:none;"></span>
                    </td>
                    <td class="time-cell" data-type="start"></td>
                    <td class="time-cell" data-type="end"></td>
                </tr>
                </tbody>
            </table>
        </div>

        <p class="text-muted small mt-3">※
            出勤・退勤のセルをクリックして時刻を設定してください。祝日は自動で表示されます。</p>
    </div>

    <!-- Time Picker -->
    <div aria-hidden="true" class="time-picker" id="timePicker" style="display:none;">
        <div class="picker-header">
            <div>
                <span class="selected-date" id="selectedDateLabel">日付: —</span>
                <span aria-hidden="true" class="selected-holiday" id="holidayLabel" style="display:none;"></span>
            </div>
            <div class="label-small" id="cellTypeLabel">種類: —</div>
        </div>

        <div class="display" id="timeDisplay">00:00</div>
        <div class="mode" id="modeLabel">時を設定してください</div>

        <div class="clock" id="clock">
            <div class="hand" id="hand"></div>
            <div class="center-dot"></div>
            <div class="drag-area" id="dragArea"></div>
        </div>
    </div>

    <style>
        .controls .group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .date-cell {
            padding-left: 12px !important;
        }

        .time-cell {
            cursor: pointer;
            background: #fafafa;
            text-align: center;
        }

        .time-cell.active {
            box-shadow: inset 0 0 0 2px rgba(0, 120, 212, 0.4);
            background: #e3f2fd;
        }

        .holiday {
            color: #c00;
            font-size: 12px;
            margin-left: 10px;
            font-weight: 600;
        }

        .weekday-sun {
            color: #c33;
            font-weight: 600;
        }

        .weekday-sat {
            color: #116;
            font-weight: 600;
        }

        /* Time Picker UI */
        .time-picker {
            position: absolute;
            width: 280px;
            padding: 12px;
            background: white;
            border: 1px solid #aaa;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
            z-index: 9999;
        }

        .picker-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 8px;
        }

        .selected-date {
            font-size: 13px;
            color: #333;
            font-weight: 600;
        }

        .selected-holiday {
            font-size: 12px;
            color: #c00;
            margin-left: 8px;
            font-weight: 600;
        }

        .display {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
            color: #0066cc;
        }

        .mode {
            text-align: center;
            margin-bottom: 10px;
            font-size: 14px;
            color: #555;
        }

        .clock {
            width: 200px;
            height: 200px;
            border: 2px solid #0066cc;
            border-radius: 50%;
            margin: auto;
            position: relative;
            background: #f8f9fa;
        }

        .hand {
            width: 3px;
            height: 80px;
            background: #0066cc;
            position: absolute;
            top: 20px;
            left: 98.5px;
            transform-origin: bottom;
            pointer-events: none;
            transition: transform 0.06s linear;
            border-radius: 2px;
        }

        .center-dot {
            width: 12px;
            height: 12px;
            background: #0066cc;
            border-radius: 50%;
            position: absolute;
            top: 94px;
            left: 94px;
            border: 2px solid white;
        }

        .drag-area {
            width: 200px;
            height: 200px;
            position: absolute;
            top: 0;
            left: 0;
            cursor: pointer;
        }

        .label-small {
            font-size: 13px;
            color: #444;
        }
    </style>

    <script th:inline="javascript">
        (function () {
            'use strict';

            const tableBody = document.getElementById('tableBody');
            const defaultStart = document.getElementById('defaultStart');
            const defaultEnd = document.getElementById('defaultEnd');
            const applyDefaultsBtn = document.getElementById('applyDefaults');
            const picker = document.getElementById('timePicker');
            const display = document.getElementById('timeDisplay');
            const hand = document.getElementById('hand');
            const modeLabel = document.getElementById('modeLabel');
            const dragArea = document.getElementById('dragArea');
            const clock = document.getElementById('clock');
            const selectedDateLabel = document.getElementById('selectedDateLabel');
            const cellTypeLabel = document.getElementById('cellTypeLabel');
            const holidayLabel = document.getElementById('holidayLabel');

            let currentCell = null;
            let selectingHour = true;
            let hour = 0;
            let minute = 0;
            let dragStarted = false;
            let dragStartTime = 0;
            const MIN_DRAG_DURATION = 120;

            const holidayCache = {};

            // 祝日取得
            async function fetchHolidays(year) {
                if (holidayCache[year]) return holidayCache[year];
                try {
                    const res = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/JP`);
                    if (!res.ok) throw new Error('holiday API error');
                    const data = await res.json();
                    const map = {};
                    for (const h of data) {
                        map[h.date] = h.localName || h.name || '';
                    }
                    holidayCache[year] = map;
                    return map;
                } catch (err) {
                    console.warn('祝日取得失敗:', err);
                    holidayCache[year] = {};
                    return {};
                }
            }

            // 初期化：祝日を表示
            (async function init() {
                const year = new Date().getFullYear();
                const holidayMap = await fetchHolidays(year);

                document.querySelectorAll('td.date-cell').forEach(cell => {
                    const iso = cell.dataset.iso;
                    if (holidayMap[iso]) {
                        const hspan = cell.querySelector('.holiday');
                        if (hspan) {
                            hspan.textContent = `祝: ${holidayMap[iso]}`;
                            hspan.style.display = '';
                        }
                    }
                });
            })();

            // デフォルト適用
            applyDefaultsBtn.addEventListener('click', () => {
                const startVal = defaultStart.value;
                const endVal = defaultEnd.value;
                document.querySelectorAll('td.time-cell').forEach(cell => {
                    if (cell.textContent.trim() === '') {
                        cell.textContent = (cell.dataset.type === 'start') ? startVal : endVal;
                    }
                });
            });

            // セルクリック
            document.getElementById('workTable').addEventListener('click', (e) => {
                const cell = e.target.closest('td.time-cell');
                if (!cell) return;

                document.querySelectorAll('td.time-cell.active').forEach(c => c.classList.remove('active'));
                cell.classList.add('active');
                currentCell = cell;

                const row = cell.parentElement;
                const dateCell = row.querySelector('td.date-cell');
                const dateText = dateCell ? dateCell.querySelector('span')?.textContent || dateCell.textContent : '—';

                selectedDateLabel.textContent = `日付: ${dateText}`;
                cellTypeLabel.textContent = `種類: ${cell.dataset.type === 'start' ? '出勤' : '退勤'}`;

                const hspan = dateCell ? dateCell.querySelector('.holiday') : null;
                if (hspan && hspan.textContent) {
                    holidayLabel.textContent = hspan.textContent.replace(/^祝:\s*/, '');
                    holidayLabel.style.display = '';
                } else {
                    holidayLabel.textContent = '';
                    holidayLabel.style.display = 'none';
                }

                const init = cell.textContent.trim();
                if (/^\d\d:\d\d$/.test(init)) {
                    const [h, m] = init.split(":").map(Number);
                    hour = h;
                    minute = m;
                } else {
                    const def = (cell.dataset.type === 'start') ? defaultStart.value : defaultEnd.value;
                    if (/^\d\d:\d\d$/.test(def)) {
                        const [h, m] = def.split(":").map(Number);
                        hour = h;
                        minute = m;
                    } else {
                        hour = 0;
                        minute = 0;
                    }
                }

                selectingHour = true;
                modeLabel.textContent = "時を設定してください";
                updateDisplay();
                setHandPositionFromTime();

                const rect = cell.getBoundingClientRect();
                const left = Math.max(8, rect.left);
                let top = rect.bottom + 6;
                const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
                if (top + picker.offsetHeight > viewportHeight - 8) {
                    top = rect.top - picker.offsetHeight - 6;
                }

                picker.style.left = left + 'px';
                picker.style.top = top + 'px';
                picker.style.display = 'block';
                picker.setAttribute('aria-hidden', 'false');
            });

            function angleToTime(angle, isHourMode) {
                if (isHourMode) {
                    const h = Math.round(angle / 30) % 12;
                    hour = h;
                } else {
                    const m = Math.round(angle / 6) % 60;
                    minute = m;
                }
                updateDisplay();
            }

            function updateDisplay() {
                display.textContent = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
            }

            function setHandPositionFromTime() {
                const angle = selectingHour ? (hour % 12) * 30 : minute * 6;
                hand.style.transform = `rotate(${angle}deg)`;
            }

            dragArea.addEventListener('mousedown', (e) => {
                dragStarted = false;
                dragStartTime = Date.now();
                document.addEventListener('mousemove', onDrag);
                document.addEventListener('mouseup', onDrop);
                e.preventDefault();
            });

            function onDrag(e) {
                dragStarted = true;
                const rect = clock.getBoundingClientRect();
                const cx = rect.left + rect.width / 2;
                const cy = rect.top + rect.height / 2;
                const dx = e.clientX - cx;
                const dy = e.clientY - cy;
                let angle = (Math.atan2(dy, dx) * 180 / Math.PI + 90 + 360) % 360;
                hand.style.transform = `rotate(${angle}deg)`;
                angleToTime(angle, selectingHour);
            }

            function onDrop(e) {
                document.removeEventListener('mousemove', onDrag);
                document.removeEventListener('mouseup', onDrop);
                const dragDuration = Date.now() - dragStartTime;
                if (dragDuration < MIN_DRAG_DURATION && !dragStarted) return;

                if (selectingHour) {
                    selectingHour = false;
                    modeLabel.textContent = "分を設定してください";
                    setHandPositionFromTime();
                } else {
                    if (currentCell) {
                        currentCell.textContent = display.textContent;
                        currentCell.classList.remove('active');
                    }
                    picker.style.display = "none";
                    picker.setAttribute('aria-hidden', 'true');
                }
            }

            document.addEventListener('mousedown', (e) => {
                if (picker.contains(e.target) || e.target.closest('td.time-cell')) return;
                document.querySelectorAll('td.time-cell.active').forEach(c => c.classList.remove('active'));
                picker.style.display = 'none';
                picker.setAttribute('aria-hidden', 'true');
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('td.time-cell.active').forEach(c => c.classList.remove('active'));
                    picker.style.display = 'none';
                    picker.setAttribute('aria-hidden', 'true');
                }
            });
        })();
    </script>
</div>

