<div th:fragment="content">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <h2 class="mb-0" th:text="${monthDisplay}">2025年11月</h2>
            <div class="d-flex gap-2 align-items-center">
                <button class="btn btn-sm btn-outline-secondary" id="prevMonth" title="前の月" type="button">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <input class="form-control form-control-sm" id="monthInput" style="width:160px;"
                       th:value="${yearMonthValue}" title="表示する月" type="month">
                <button class="btn btn-sm btn-outline-secondary" id="nextMonth" title="次の月" type="button">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- controls -->
        <div class="controls mb-3 d-flex gap-3 align-items-center flex-wrap">
            <div class="d-flex gap-2 align-items-center">
                <label class="form-label mb-0 small" for="defaultStart">出勤デフォルト：</label>
                <input class="form-control form-control-sm" id="defaultStart" style="width:110px;"
                       title="出勤時刻のデフォルト値"
                       type="time" value="09:00">
                <label class="form-label mb-0 small" for="defaultEnd">退勤デフォルト：</label>
                <input class="form-control form-control-sm" id="defaultEnd" style="width:110px;"
                       title="退勤時刻のデフォルト値"
                       type="time" value="18:00">
                <button class="btn btn-sm btn-secondary" id="applyDefaults">空セルに適用</button>
            </div>
        </div>

        <div class="alert alert-success py-2 px-3 mb-3 d-flex align-items-center gap-2" role="alert">
            <i class="bi bi-check-circle"></i>
            <small><strong>リアルタイム保存有効：</strong> 時刻を設定すると自動的に保存されます</small>
        </div>

        <div class="table-responsive" style="max-height: calc(100vh - 280px); overflow-y: auto;">
            <table class="table table-sm table-bordered table-hover" id="workTable">
                <thead class="table-light">
                <tr>
                    <th style="width:280px;">日付</th>
                    <th style="width:100px;">出勤</th>
                    <th style="width:100px;">退勤</th>
                </tr>
                </thead>
                <tbody id="tableBody">
                <tr th:classappend="${d == T(java.time.LocalDate).now()} ? 'table-primary' : ''"
                    th:each="d : ${dates}">
                    <td class="date-cell text-start"
                        th:data-iso="${#temporals.format(d, 'yyyy-MM-dd')}"
                        th:title="${#temporals.format(d, 'yyyy-MM-dd')}">
                        <span th:classappend="${#temporals.dayOfWeek(d) == 7} ? 'weekday-sun' : (${#temporals.dayOfWeek(d) == 6} ? 'weekday-sat' : '')"
                              th:text="${#temporals.format(d, 'MM/dd (E)')}">11/23 (土)</span>
                        <span class="holiday" style="display:none;"></span>
                    </td>
                    <td class="time-cell" data-type="start"></td>
                    <td class="time-cell" data-type="end"></td>
                </tr>
                </tbody>
            </table>
        </div>

        <p class="text-muted small mt-3">※
            出勤・退勤のセルをクリックして時刻を設定してください。祝日は自動で表示されます。</p>
    </div>

    <!-- Time Picker -->
    <div aria-hidden="true" class="time-picker" id="timePicker" style="display:none;">
        <div class="picker-header">
            <div>
                <span class="selected-date" id="selectedDateLabel">日付: —</span>
                <span aria-hidden="true" class="selected-holiday" id="holidayLabel" style="display:none;"></span>
            </div>
            <div class="label-small" id="cellTypeLabel">種類: —</div>
        </div>

        <div class="display" id="timeDisplay">00:00</div>
        <div class="mode" id="modeLabel">時を設定してください (0-23)</div>

        <div class="clock" id="clock">
            <div class="hand" id="hand"></div>
            <div class="center-dot"></div>
            <div class="drag-area" id="dragArea"></div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        (function () {
            'use strict';

            const defaultStart = document.getElementById('defaultStart');
            const defaultEnd = document.getElementById('defaultEnd');
            const applyDefaultsBtn = document.getElementById('applyDefaults');
            const picker = document.getElementById('timePicker');
            const display = document.getElementById('timeDisplay');
            const hand = document.getElementById('hand');
            const modeLabel = document.getElementById('modeLabel');
            const dragArea = document.getElementById('dragArea');
            const clock = document.getElementById('clock');
            const selectedDateLabel = document.getElementById('selectedDateLabel');
            const cellTypeLabel = document.getElementById('cellTypeLabel');
            const holidayLabel = document.getElementById('holidayLabel');
            const monthInput = document.getElementById('monthInput');
            const prevBtn = document.getElementById('prevMonth');
            const nextBtn = document.getElementById('nextMonth');

            let currentCell = null;
            let selectingHour = true;
            let hour = 0;
            let minute = 0;
            let dragStarted = false;
            let dragStartTime = 0;
            const MIN_DRAG_DURATION = 120;

            const holidayCache = {};
            let autoSaveTimer = null;
            const AUTO_SAVE_DELAY = 800; // 0.8秒後に自動保存

            async function fetchHolidays(year) {
                if (holidayCache[year]) return holidayCache[year];
                try {
                    const res = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/JP`);
                    if (!res.ok) {
                        holidayCache[year] = {};
                        return {};
                    }
                    const data = await res.json();
                    const map = {};
                    for (const h of data) {
                        map[h.date] = h.localName || h.name || '';
                    }
                    holidayCache[year] = map;
                    return map;
                } catch (err) {
                    console.warn('祝日取得失敗:', err);
                    holidayCache[year] = {};
                    return {};
                }
            }

            (async function init() {
                const year = new Date().getFullYear();
                const holidayMap = await fetchHolidays(year);

                document.querySelectorAll('td.date-cell').forEach(cell => {
                    const iso = cell.dataset.iso;
                    if (holidayMap[iso]) {
                        const hspan = cell.querySelector('.holiday');
                        if (hspan) {
                            hspan.textContent = `祝: ${holidayMap[iso]}`;
                            hspan.style.display = '';
                        }
                    }
                });
            })();

            applyDefaultsBtn.addEventListener('click', () => {
                const startVal = defaultStart.value;
                const endVal = defaultEnd.value;
                document.querySelectorAll('td.time-cell').forEach(cell => {
                    if (cell.textContent.trim() === '') {
                        cell.textContent = (cell.dataset.type === 'start') ? startVal : endVal;
                    }
                });
            });

            document.getElementById('workTable').addEventListener('click', (e) => {
                const cell = e.target.closest('td.time-cell');
                if (!cell) return;

                document.querySelectorAll('td.time-cell.active').forEach(c => c.classList.remove('active'));
                cell.classList.add('active');
                currentCell = cell;

                const row = cell.parentElement;
                const dateCell = row.querySelector('td.date-cell');
                const dateText = dateCell ? dateCell.querySelector('span')?.textContent || dateCell.textContent : '—';

                selectedDateLabel.textContent = `日付: ${dateText}`;
                cellTypeLabel.textContent = `種類: ${cell.dataset.type === 'start' ? '出勤' : '退勤'}`;

                const hspan = dateCell ? dateCell.querySelector('.holiday') : null;
                if (hspan && hspan.textContent) {
                    holidayLabel.textContent = hspan.textContent.replace(/^祝:\s*/, '');
                    holidayLabel.style.display = '';
                } else {
                    holidayLabel.textContent = '';
                    holidayLabel.style.display = 'none';
                }

                const init = cell.textContent.trim();
                if (/^\d\d:\d\d$/.test(init)) {
                    [hour, minute] = init.split(":").map(Number);
                } else {
                    const def = (cell.dataset.type === 'start') ? defaultStart.value : defaultEnd.value;
                    if (/^\d\d:\d\d$/.test(def)) {
                        [hour, minute] = def.split(":").map(Number);
                    } else {
                        hour = 0;
                        minute = 0;
                    }
                }

                selectingHour = true;
                modeLabel.textContent = "時を設定してください (0-23)";
                updateDisplay();
                setHandPositionFromTime();

                const rect = cell.getBoundingClientRect();
                const left = Math.max(8, rect.left);
                let top = rect.bottom + 6;
                const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
                if (top + picker.offsetHeight > viewportHeight - 8) {
                    top = rect.top - picker.offsetHeight - 6;
                }

                picker.style.left = left + 'px';
                picker.style.top = top + 'px';
                picker.style.display = 'block';
                picker.setAttribute('aria-hidden', 'false');
            });

            // 24時間制対応ロジック ---------------------------------
            function angleToTime(angle, isHourMode) {
                if (isHourMode) {
                    // 360度を24分割 => 15度/時。丸めて0-23に正規化
                    hour = Math.round(angle / 15) % 24;
                } else {
                    // 分は従来通り 6度/分 (60分)
                    minute = Math.round(angle / 6) % 60;
                }
                updateDisplay();
            }

            function updateDisplay() {
                display.textContent = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
            }

            function setHandPositionFromTime() {
                // 時モード: 15度 * 時 (0-23)。分モード: 6度 * 分
                const angle = selectingHour ? (hour % 24) * 15 : minute * 6;
                hand.style.transform = `rotate(${angle}deg)`;
            }

            dragArea.addEventListener('mousedown', () => {
                dragStarted = false;
                dragStartTime = Date.now();
                document.addEventListener('mousemove', onDrag);
                document.addEventListener('mouseup', onDrop);
            });

            function onDrag(e) {
                dragStarted = true;
                const rect = clock.getBoundingClientRect();
                const cx = rect.left + rect.width / 2;
                const cy = rect.top + rect.height / 2;
                const dx = e.clientX - cx;
                const dy = e.clientY - cy;
                const angle = (Math.atan2(dy, dx) * 180 / Math.PI + 90 + 360) % 360;
                hand.style.transform = `rotate(${angle}deg)`;
                angleToTime(angle, selectingHour);
            }

            function onDrop() {
                document.removeEventListener('mousemove', onDrag);
                document.removeEventListener('mouseup', onDrop);
                const dragDuration = Date.now() - dragStartTime;
                if (dragDuration < MIN_DRAG_DURATION && !dragStarted) return;

                if (selectingHour) {
                    selectingHour = false;
                    modeLabel.textContent = "分を設定してください (0-59)";
                    setHandPositionFromTime();
                } else {
                    if (currentCell) {
                        currentCell.textContent = display.textContent;
                        currentCell.classList.remove('active');
                        // リアルタイム自動保存をトリガー
                        scheduleAutoSave(currentCell);
                    }
                    picker.style.display = "none";
                    picker.setAttribute('aria-hidden', 'true');
                }
            }

            // -----------------------------------------------------

            document.addEventListener('mousedown', (e) => {
                if (picker.contains(e.target) || e.target.closest('td.time-cell')) return;
                document.querySelectorAll('td.time-cell.active').forEach(c => c.classList.remove('active'));
                picker.style.display = 'none';
                picker.setAttribute('aria-hidden', 'true');
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('td.time-cell.active').forEach(c => c.classList.remove('active'));
                    picker.style.display = 'none';
                    picker.setAttribute('aria-hidden', 'true');
                }
            });

            function changeMonth(value) {
                if (value) window.location.href = `/timesheet?month=${value}`;
            }

            monthInput && monthInput.addEventListener('change', e => changeMonth(e.target.value));
            prevBtn && prevBtn.addEventListener('click', () => {
                const [y, m] = monthInput.value.split('-').map(Number);
                const d = new Date(y, m - 2, 1);
                changeMonth(`${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`);
            });
            nextBtn && nextBtn.addEventListener('click', () => {
                const [y, m] = monthInput.value.split('-').map(Number);
                const d = new Date(y, m, 1);
                changeMonth(`${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`);
            });

            // 登録・読込機能
            function getCsrf() {
                const token = document.querySelector('meta[name="_csrf"]');
                const header = document.querySelector('meta[name="_csrf_header"]');
                return token && header ? {token: token.content, header: header.content} : null;
            }

            function scheduleAutoSave(cell) {
                if (autoSaveTimer) {
                    clearTimeout(autoSaveTimer);
                }

                // セルに保存中インジケータを追加
                cell.classList.add('saving');

                autoSaveTimer = setTimeout(async () => {
                    await performAutoSave(cell);
                }, AUTO_SAVE_DELAY);
            }

            async function performAutoSave(cell) {
                const row = cell.parentElement;
                const dateCell = row.querySelector('td.date-cell');
                const startCell = row.querySelectorAll('td.time-cell')[0];
                const endCell = row.querySelectorAll('td.time-cell')[1];

                const workDate = dateCell ? dateCell.dataset.iso : null;
                const startTime = startCell ? startCell.textContent.trim() : '';
                const endTime = endCell ? endCell.textContent.trim() : '';

                if (!workDate) {
                    cell.classList.remove('saving');
                    return;
                }

                const csrf = getCsrf();
                const headers = {'Content-Type': 'application/json'};
                if (csrf) headers[csrf.header] = csrf.token;

                try {
                    const resp = await fetch('/timesheet/api/batch', {
                        method: 'POST',
                        headers,
                        body: JSON.stringify({
                            entries: [{
                                workDate,
                                startTime: startTime || null,
                                endTime: endTime || null
                            }]
                        }),
                        credentials: 'same-origin'
                    });

                    if (resp.ok) {
                        cell.classList.remove('saving');
                        cell.classList.add('saved');
                        setTimeout(() => cell.classList.remove('saved'), 1500);
                        console.log('自動保存成功:', workDate);
                    } else {
                        cell.classList.remove('saving');
                        cell.classList.add('save-error');
                        setTimeout(() => cell.classList.remove('save-error'), 2000);
                        console.error('自動保存失敗:', resp.status);
                    }
                } catch (err) {
                    cell.classList.remove('saving');
                    cell.classList.add('save-error');
                    setTimeout(() => cell.classList.remove('save-error'), 2000);
                    console.error('自動保存エラー:', err);
                }
            }

            // ページ読み込み時に自動でデータを読み込む
            async function loadTimesheetData() {
                const [year, month] = monthInput.value.split('-').map(Number);
                const from = `${year}-${String(month).padStart(2, '0')}-01`;
                const lastDay = new Date(year, month, 0).getDate();
                const to = `${year}-${String(month).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`;

                try {
                    const resp = await fetch(`/timesheet/api?from=${from}&to=${to}`, {
                        credentials: 'same-origin'
                    });

                    if (!resp.ok) {
                        if (resp.status !== 404) {
                            console.warn(`データ読込失敗: ${resp.status}`);
                        }
                        return;
                    }

                    const entries = await resp.json();
                    const entryMap = {};
                    entries.forEach(e => {
                        entryMap[e.workDate] = {start: e.startTime, end: e.endTime};
                    });

                    document.querySelectorAll('#tableBody tr').forEach(row => {
                        const dateCell = row.querySelector('td.date-cell');
                        const startCell = row.querySelectorAll('td.time-cell')[0];
                        const endCell = row.querySelectorAll('td.time-cell')[1];

                        const workDate = dateCell ? dateCell.dataset.iso : null;
                        if (workDate && entryMap[workDate]) {
                            const data = entryMap[workDate];
                            if (startCell) startCell.textContent = data.start || '';
                            if (endCell) endCell.textContent = data.end || '';
                        }
                    });

                    if (entries.length > 0) {
                        console.log(`${entries.length}件のデータを読み込みました`);
                    }
                } catch (err) {
                    console.error('データ読込エラー:', err);
                }
            }

            // 初期化時に自動読み込み
            (async function autoLoad() {
                await loadTimesheetData();
            })();
        })();
        /*]]>*/
    </script>
</div>
