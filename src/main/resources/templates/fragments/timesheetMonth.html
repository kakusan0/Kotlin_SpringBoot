<div th:fragment="content">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <h2 class="mb-0" th:text="${monthDisplay}">2025年11月</h2>
            <div class="d-flex gap-2 align-items-center">
                <button class="btn btn-sm btn-outline-secondary" id="prevMonth" title="前の月" type="button">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <input class="form-control form-control-sm" id="monthInput" style="width:160px;"
                       th:value="${yearMonthValue}" title="表示する月" type="month">
                <button class="btn btn-sm btn-outline-secondary" id="nextMonth" title="次の月" type="button">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- controls -->
        <div class="controls mb-3 d-flex gap-3 align-items-center flex-wrap">
            <div class="d-flex gap-2 align-items-center">
                <label class="form-label mb-0 small" for="defaultStart">出勤デフォルト：</label>
                <input class="form-control form-control-sm" id="defaultStart" style="width:110px;"
                       title="出勤時刻のデフォルト値"
                       type="time" value="09:00">
                <label class="form-label mb-0 small" for="defaultEnd">退勤デフォルト：</label>
                <input class="form-control form-control-sm" id="defaultEnd" style="width:110px;"
                       title="退勤時刻のデフォルト値"
                       type="time" value="18:00">
                <label class="form-label mb-0 small" for="defaultBreak">休憩(分)デフォルト：</label>
                <input class="form-control form-control-sm" id="defaultBreak" min="0" style="width:90px;" type="number"
                       value="60">
                <button class="btn btn-sm btn-secondary" id="applyDefaults">空セルに適用</button>
            </div>
        </div>

        <!-- Report buttons: placed above the table, right-aligned -->
        <div class="d-flex justify-content-end align-items-center mb-2">
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" id="downloadCsvBtn" type="button">CSV ダウンロード
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="downloadPdfBtn" type="button">PDF ダウンロード
                </button>
                <button class="btn btn-sm btn-success" id="downloadXlsxBtn" type="button">Excel ダウンロード</button>
            </div>
        </div>
        <div aria-live="polite" class="text-muted small mb-2" id="reportMessage"></div>

        <!-- テーブルヘッダ拡張 -->
        <div class="table-responsive" style="max-height: calc(100vh - 280px); overflow-y: auto;">
            <table class="table table-sm table-bordered table-hover" id="workTable">
                <thead class="table-light">
                <tr>
                    <th style="width:180px;">日付</th>
                    <th style="width:60px;">曜日</th>
                    <th style="width:110px;">休日出勤</th>
                    <th style="width:90px;">出勤</th>
                    <th style="width:90px;">退勤</th>
                    <th style="width:80px;">休憩</th>
                    <th style="width:90px;">稼働</th>
                    <th style="width:90px;">実働</th>
                </tr>
                </thead>
                <tbody id="tableBody">
                <tr th:classappend="${d == T(java.time.LocalDate).now()} ? 'table-primary' : ''" th:each="d : ${dates}">
                    <td class="date-cell" th:data-iso="${#temporals.format(d,'yyyy-MM-dd')}">
                        <span th:text="${#temporals.format(d,'MM/dd')}">11/24</span>
                        <span class="holiday" style="display:none;"></span>
                    </td>
                    <td class="weekday-cell"></td>
                    <td class="holiday-cell">
                        <div class="form-check form-switch">
                            <input aria-label="休日出勤" class="form-check-input holiday-switch" role="switch"
                                   type="checkbox">
                        </div>
                    </td>
                    <td class="time-cell" data-type="start"></td>
                    <td class="time-cell" data-type="end"></td>
                    <td class="break-cell" contenteditable="true"></td>
                    <td class="duration-cell"></td>
                    <td class="working-cell"></td>
                </tr>
                </tbody>
            </table>
        </div>

        <p class="text-muted small mt-3">※
            出勤・退勤のセルをクリックして時刻を設定してください。祝日は自動で表示されます。</p>
    </div>

    <!-- Time Picker -->
    <div aria-hidden="true" class="time-picker" id="timePicker" style="display:none;">
        <div class="picker-header">
            <div>
                <span class="selected-date" id="selectedDateLabel">日付: —</span>
                <span aria-hidden="true" class="selected-holiday" id="holidayLabel" style="display:none;"></span>
            </div>
            <div class="label-small" id="cellTypeLabel">種類: —</div>
        </div>

        <div class="display" id="timeDisplay">00:00</div>
        <div class="mode" id="modeLabel">時を設定してください (0-23)</div>

        <div class="clock" id="clock">
            <div class="hand" id="hand"></div>
            <div class="center-dot"></div>
            <div class="drag-area" id="dragArea"></div>
        </div>
    </div>

    <!-- Conflict Modal -->
    <div aria-hidden="true" class="modal fade" id="conflictModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">競合が発生しました</h5>
                    <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
                </div>
                <div class="modal-body">
                    <p>他の端末で同じ日付が更新されました。どうしますか？</p>
                    <p class="small text-muted">
                        再読み込みすると最新データを取得します。強制上書きを選ぶと現在の編集内容で上書きします。</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="conflictReload" type="button">再読み込み</button>
                    <button class="btn btn-danger" id="conflictForce" type="button">強制上書き</button>
                </div>
            </div>
        </div>
    </div>

    <script defer th:src="@{/js/timesheetMonth.js}"></script>
    <script th:inline="javascript">
        window.currentUserName = /*[[${currentUserName}]]*/ 'user1';
    </script>
</div>
