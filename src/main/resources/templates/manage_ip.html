<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: commonHead('IP管理')}">
    <title>IP管理</title>
</head>
<body>
<!-- 固定ヘッダー（簡易コピー） -->
<header class="header">
    <div class="d-flex align-items-center h-100 px-3 px-md-5 position-relative">
        <div>
            <button aria-controls="sidebarMenu" aria-label="メニューを開く" class="btn btn-primary d-md-none border-0"
                    data-bs-target="#sidebarMenu" data-bs-toggle="offcanvas" type="button">
                <i class="bi bi-list"></i>
            </button>
            <button aria-label="サイドバーを開閉" class="btn btn-primary d-none d-md-block border-0"
                    id="pcSidebarToggle" type="button">
                <i class="bi bi-list"></i>
            </button>
        </div>
        <div class="position-absolute top-50 start-50 translate-middle d-flex align-items-center">
            <strong>IP管理</strong>
        </div>
    </div>
</header>

<!-- サイドバー（共通フラグメント） -->
<div th:replace="~{fragments/sidebar :: adminSidebar}"></div>

<main class="main-content p-4">
    <div class="container-fluid">
        <h2 class="mb-3">IP管理</h2>

        <!-- IP検索ボックス -->
        <div class="mb-4">
            <div class="input-group" id="ipSearchBox">
                <span aria-hidden="true" class="input-group-text" id="ipSearchIcon"><i class="bi bi-search"></i></span>
                <input aria-label="IPアドレス検索" class="form-control" id="ipSearchInput"
                       placeholder="IPアドレスを検索（部分一致）"
                       type="text">
                <button aria-label="検索条件をクリア" class="btn btn-outline-secondary" id="ipSearchClear"
                        type="button">クリア
                </button>
            </div>
            <div class="mt-2 d-flex gap-2 flex-wrap">
                <button class="btn btn-warning" id="btnAutoBlacklistUaMissing" type="button">
                    UA欠損IPを一括ブラックリスト化
                </button>
                <small class="text-muted">アクセスログで User-Agent
                    が空のIPを対象に、自動でブラックリスト登録します。</small>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">ブラックリスト登録</div>
            <div class="card-body d-flex gap-2 align-items-center flex-wrap">
                <select aria-label="ホワイトリストから選択" class="form-select" id="whitelistSelectForBlacklist"
                        style="max-width: 360px;">
                    <option value="">ホワイトリストから選択...</option>
                    <option th:disabled="${w.blacklisted}"
                            th:each="w : ${whitelist}"
                            th:text="${w.ipAddress + (w.blacklisted ? '（登録済）' : '')}"
                            th:value="${w.ipAddress}">
                    </option>
                </select>
                <button class="btn btn-outline-danger" id="btnAddToBlacklist">ブラックリストに登録</button>
                <small class="text-muted">※ 既にブラックリスト登録済みのIPは選択できません。</small>
            </div>
        </div>

        <h2>ホワイトリストIP一覧</h2>
        <table class="table table-bordered" id="whitelistTable">
            <thead>
            <tr>
                <th>ID</th>
                <th>IPアドレス</th>
                <th>最新パス</th>
                <th>最新UA</th>
                <th>登録日時</th>
                <th>BL</th>
                <th>BL回数</th>
            </tr>
            </thead>
            <tbody>
            <tr th:attr="data-ip=${ip.ipAddress}" th:each="ip : ${whitelist}">
                <td th:text="${ip.id}"></td>
                <td th:text="${ip.ipAddress}"></td>
                <td class="text-truncate" style="max-width: 320px;"
                    th:text="${latestPathsByIp[ip.ipAddress]} ?: '-'"></td>
                <td class="text-truncate" style="max-width: 360px;"
                    th:text="${latestUserAgentsByIp[ip.ipAddress]} ?: '-'"></td>
                <td th:text="${#temporals.format(ip.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
                <td><span th:text="${ip.blacklisted ? '✔' : ''}"></span></td>
                <td th:text="${ip.blacklistedCount}"></td>
            </tr>
            </tbody>
        </table>

        <h2>ブラックリストIP一覧</h2>
        <table class="table table-bordered" id="blacklistTable">
            <thead>
            <tr>
                <th>ID</th>
                <th>IPアドレス</th>
                <th>最新パス</th>
                <th>最新UA</th>
                <th>登録日時</th>
                <th>回数</th>
                <th>削除フラグ</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            <tr th:attr="data-ip=${ip.ipAddress}" th:each="ip : ${blacklist}">
                <td th:text="${ip.id}"></td>
                <td th:text="${ip.ipAddress}"></td>
                <td class="text-truncate" style="max-width: 320px;"
                    th:text="${latestPathsByIp[ip.ipAddress]} ?: '-'"></td>
                <td class="text-truncate" style="max-width: 360px;"
                    th:text="${latestUserAgentsByIp[ip.ipAddress]} ?: '-'"></td>
                <td th:text="${#temporals.format(ip.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
                <td th:text="${ip.times}"></td>
                <td><span th:text="${ip.deleted ? '✔' : ''}"></span></td>
                <td>
                    <button class="btn btn-sm btn-outline-danger btn-blacklist-delete" th:attr="data-id=${ip.id}"
                            th:disabled="${ip.deleted}">削除（論理）
                    </button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</main>

<script defer th:src="@{/js/ip-manage.js}"></script>
</body>
</html>
