<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>勤怠管理</title>
    <link href="/webjars/bootstrap/5.3.8/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="/webjars/bootstrap-icons/1.13.1/font/bootstrap-icons.css" rel="stylesheet"/>
    <style>
        .working {
            color: #28a745;
            font-weight: bold;
        }
    </style>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body class="container py-4">
<h1>勤怠管理 (リアルタイム)</h1>
<div class="mb-3">
    <button class="btn btn-success btn-lg" id="registerBtn">
        <i class="bi bi-calendar-check"></i> 勤怠登録
    </button>
</div>
<div class="mb-3" id="status"></div>
<div class="card mb-3">
    <div class="card-body">
        <h5 class="card-title">打刻操作</h5>
        <div class="d-flex gap-2">
            <button class="btn btn-primary" id="clockInBtn">
                <i class="bi bi-box-arrow-in-right"></i> 出勤
            </button>
            <button class="btn btn-danger" id="clockOutBtn">
                <i class="bi bi-box-arrow-left"></i> 退勤
            </button>
        </div>
    </div>
</div>
<div class="mb-3">
    <label class="form-label" for="noteInput">メモ</label>
    <textarea class="form-control" id="noteInput" rows="2"></textarea>
    <button class="btn btn-secondary mt-2" id="noteSaveBtn">
        <i class="bi bi-save"></i> メモ保存
    </button>
</div>
<table class="table table-sm" id="historyTable">
    <thead>
    <tr>
        <th>日付</th>
        <th>開始</th>
        <th>終了</th>
        <th>メモ</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>
<script src="/webjars/bootstrap/5.3.8/js/bootstrap.bundle.min.js"></script>
<script>
    const statusEl = document.getElementById('status');
    const historyTBody = document.querySelector('#historyTable tbody');
    const clockInBtn = document.getElementById('clockInBtn');
    const clockOutBtn = document.getElementById('clockOutBtn');
    const registerBtn = document.getElementById('registerBtn');
    const noteInput = document.getElementById('noteInput');
    const noteSaveBtn = document.getElementById('noteSaveBtn');

    let currentEntry = null; // 現在の勤怠レコード保持

    function fmt(t) {
        return t ? t : ''
    }

    function renderRow(entry) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${entry.workDate}</td><td>${fmt(entry.startTime)}</td><td>${fmt(entry.endTime)}</td><td>${entry.note || ''}</td>`;
        return tr;
    }

    async function loadRange() {
        const today = new Date().toISOString().substring(0, 10);
        const resp = await fetch(`/timesheet/api?from=${today}&to=${today}`);
        if (!resp.ok) {
            return;
        }
        const list = await resp.json();
        historyTBody.innerHTML = '';
        list.forEach(e => historyTBody.appendChild(renderRow(e)));
        updateStatus(list[0]);
    }

    async function loadToday() {
        const resp = await fetch('/timesheet/api/today');
        if (!resp.ok) {
            statusEl.textContent = '取得失敗';
            return;
        }
        const entry = await resp.json();
        updateStatus(entry);
    }

    function updateStatus(entry) {
        currentEntry = entry;
        if (!entry) {
            statusEl.textContent = '未出勤';
            registerBtn.innerHTML = '<i class="bi bi-box-arrow-in-right"></i> 出勤登録';
            registerBtn.className = 'btn btn-success btn-lg';
            return;
        }
        if (entry.endTime == null) {
            statusEl.innerHTML = `<span class='working'>勤務中</span> 開始: ${entry.startTime}`;
            registerBtn.innerHTML = '<i class="bi bi-box-arrow-left"></i> 退勤登録';
            registerBtn.className = 'btn btn-danger btn-lg';
        } else {
            statusEl.textContent = `完了 開始: ${entry.startTime} / 終了: ${entry.endTime}`;
            registerBtn.innerHTML = '<i class="bi bi-check-circle"></i> 登録済';
            registerBtn.className = 'btn btn-secondary btn-lg';
            registerBtn.disabled = true;
        }
        noteInput.value = entry.note || '';
    }

    function getCsrf() {
        const t = document.querySelector('meta[name="_csrf"]');
        const h = document.querySelector('meta[name="_csrf_header"]');
        return t && h ? {token: t.getAttribute('content'), header: h.getAttribute('content')} : null;
    }

    async function doPost(url, bodyObj) {
        const csrf = getCsrf();
        const headers = {};
        if (bodyObj) {
            headers['Content-Type'] = 'application/json';
        }
        if (csrf) {
            headers[csrf.header] = csrf.token;
        }
        const resp = await fetch(url, {
            method: 'POST',
            headers,
            body: bodyObj ? JSON.stringify(bodyObj) : undefined,
            credentials: 'same-origin'
        });
        if (!resp.ok) {
            const txt = await resp.text();
            statusEl.innerHTML = `<div class='text-danger'>失敗 (${resp.status}) ${txt.substring(0, 120)}</div>`;
            throw new Error('POST failed ' + resp.status);
        }
        return resp.json();
    }

    registerBtn.onclick = async () => {
        try {
            if (!currentEntry || currentEntry.startTime == null) {
                // 未出勤 → 出勤
                const data = await doPost('/timesheet/api/clock-in');
                updateStatus(data);
                loadRange();
            } else if (currentEntry.endTime == null) {
                // 勤務中 → 退勤
                const data = await doPost('/timesheet/api/clock-out');
                updateStatus(data);
                loadRange();
            }
        } catch (e) {
            console.error(e);
        }
    };

    clockInBtn.onclick = async () => {
        try {
            const data = await doPost('/timesheet/api/clock-in');
            updateStatus(data);
            loadRange();
        } catch (e) {
            console.error(e);
        }
    };
    clockOutBtn.onclick = async () => {
        try {
            const data = await doPost('/timesheet/api/clock-out');
            updateStatus(data);
            loadRange();
        } catch (e) {
            console.error(e);
        }
    };

    let noteDirty = false;
    let autoSaveTimer = null;
    let lastSentValue = '';

    function markDirty() {
        if (!noteDirty) {
            noteDirty = true;
            statusEl.insertAdjacentHTML('beforeend', " <small class='text-warning' id='noteDirtyMark'>(未保存)</small>");
        }
    }

    function clearDirty() {
        noteDirty = false;
        const mk = document.getElementById('noteDirtyMark');
        if (mk) mk.remove();
    }

    function scheduleAutoSave() {
        if (autoSaveTimer) {
            clearTimeout(autoSaveTimer);
        }
        autoSaveTimer = setTimeout(async () => {
            const val = noteInput.value;
            if (val === lastSentValue) {
                clearDirty();
                return;
            }
            try {
                await doPost('/timesheet/api/note', {note: val});
                lastSentValue = val;
                clearDirty();
            } catch (e) {
                console.error(e);
            }
        }, 1500); // 1.5秒デバウンス
    }

    noteInput.addEventListener('input', () => {
        markDirty();
        scheduleAutoSave();
    });
    window.addEventListener('beforeunload', () => {
        if (noteDirty) {
            const note = encodeURIComponent(noteInput.value);
            const url = `/timesheet/api/note/saveBeacon?note=${note}`;
            navigator.sendBeacon && navigator.sendBeacon(url);
        }
    });

    // 既存ボタンによる明示保存も残す
    noteSaveBtn.onclick = async () => {
        try {
            const data = await doPost('/timesheet/api/note', {note: noteInput.value});
            lastSentValue = noteInput.value;
            updateStatus(data);
            loadRange();
            clearDirty();
        } catch (e) {
            console.error(e);
        }
    };

    function handleIncoming(entry) {
        const incomingNote = entry.note || '';
        if (incomingNote !== noteInput.value) {
            noteInput.value = incomingNote;
            lastSentValue = incomingNote;
            clearDirty();
        }
    }

    function createSse() {
        const es = new EventSource('/timesheet/api/stream');
        let backoff = 1000; // 1s から指数的に
        es.addEventListener('heartbeat', () => {/* no-op keepalive */
        });
        ['clock-in', 'clock-out', 'note'].forEach(ev => {
            es.addEventListener(ev, e => {
                try {
                    const data = JSON.parse(e.data);
                    updateStatus(data);
                    handleIncoming(data);
                    loadRange();
                } catch (err) {
                }
            });
        });
        es.onerror = () => {
            es.close();
            setTimeout(() => {
                createSse();
                backoff = Math.min(backoff * 2, 30000);
            }, backoff);
        };
        return es;
    }

    function openStream() {
        window.__ts_es && window.__ts_es.close();
        window.__ts_es = createSse();
    }

    openStream();
    loadRange();
    loadToday();
</script>
</body>
</html>
