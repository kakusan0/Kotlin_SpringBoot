<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.mapper.ContentItemMapper">

  <resultMap id="BaseResultMap" type="com.example.demo.model.ContentItem">
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="item_name" jdbcType="VARCHAR" property="itemName" />
    <result column="menu_name" jdbcType="VARCHAR" property="menuName" />
    <result column="path_name" jdbcType="VARCHAR" property="pathName" />
    <result column="created_at" jdbcType="TIMESTAMP" property="createdAt" javaType="java.time.OffsetDateTime" />
    <result column="updated_at" jdbcType="TIMESTAMP" property="updatedAt" javaType="java.time.OffsetDateTime" />
    <result column="enabled" jdbcType="BOOLEAN" property="enabled" />
  </resultMap>

    <sql id="Base_Column_List">ci.id as id, ci.item_name as item_name, ci.menu_name as menu_name, ci.path_name as path_name, ci.created_at as created_at, ci.updated_at as updated_at, ci.enabled as enabled</sql>
    <sql id="Base_Column_List_Simple">id, item_name, menu_name, path_name, created_at, updated_at, enabled</sql>

    <!-- 管理画面用：削除済みメニュー/パスも含めてすべて取得 -->
  <select id="selectAll" resultMap="BaseResultMap">
      SELECT
      <include refid="Base_Column_List_Simple"/>
    FROM content_items
    WHERE enabled = TRUE
    ORDER BY id
  </select>

    <!-- ホームページ用：削除されていないメニュー/パスのみ取得 -->
    <select id="selectAllForHome" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM content_items ci
        LEFT JOIN menus m ON ci.menu_name = m.name AND m.deleted = FALSE
        LEFT JOIN paths p ON ci.path_name = p.name AND p.deleted = FALSE
        WHERE ci.enabled = TRUE
        AND (ci.menu_name IS NULL OR ci.menu_name = '' OR m.id IS NOT NULL)
        AND (ci.path_name IS NULL OR ci.path_name = '' OR p.id IS NOT NULL)
        ORDER BY ci.id
    </select>

    <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List_Simple"/>
    FROM content_items
    WHERE id = #{id} AND enabled = TRUE
  </select>

  <select id="selectByMenuName" parameterType="java.lang.String" resultMap="BaseResultMap">
      SELECT
      <include refid="Base_Column_List_Simple"/>
    FROM content_items
    WHERE menu_name = #{menuName} AND enabled = TRUE
    ORDER BY id
  </select>

  <insert id="insert" parameterType="com.example.demo.model.ContentItem" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO content_items (item_name, menu_name, path_name, created_at, updated_at, enabled)
    VALUES (
      #{itemName,jdbcType=VARCHAR},
      #{menuName,jdbcType=VARCHAR},
      #{pathName,jdbcType=VARCHAR},
      #{createdAt,jdbcType=TIMESTAMP,javaType=java.time.OffsetDateTime},
      #{updatedAt,jdbcType=TIMESTAMP,javaType=java.time.OffsetDateTime},
      #{enabled,jdbcType=BOOLEAN}
    )
  </insert>

  <update id="updateByPrimaryKey" parameterType="com.example.demo.model.ContentItem">
    UPDATE content_items
    SET item_name = #{itemName,jdbcType=VARCHAR},
        menu_name = #{menuName,jdbcType=VARCHAR},
        path_name = #{pathName,jdbcType=VARCHAR},
        created_at = #{createdAt,jdbcType=TIMESTAMP,javaType=java.time.OffsetDateTime},
        updated_at = #{updatedAt,jdbcType=TIMESTAMP,javaType=java.time.OffsetDateTime}
    WHERE id = #{id,jdbcType=BIGINT}
  </update>

  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    DELETE FROM content_items WHERE id = #{id}
  </delete>

</mapper>